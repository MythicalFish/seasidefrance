---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import type { PropertyPage } from 'src/data/properties/types';

interface Props {
  property: PropertyPage;
}

const { property } = Astro.props;
const { lodgify } = property;

// Use import.meta.glob to import all images
const images = import.meta.glob<{ default: ImageMetadata }>('/src/photos/**/*.{jpg,jpeg,png}');

// Find the main image for this property based on the Lodgify URL
const getMainImage = () => {
  if (!lodgify.imageUrl) return null;

  // Extract filename from Lodgify URL
  const filename = lodgify.imageUrl.split('/').pop()?.split('?')[0];

  // Look for matching image in our photos directory
  const imagePath = Object.keys(images).find(
    (path) => path.includes(`/photos/${property.id}/`) && path.includes(filename || '')
  );

  return imagePath ? images[imagePath] : null;
};

const mainImage = getMainImage();
---

{
  mainImage ? (
    <Image
      src={mainImage()}
      alt={property.name}
      width={1200}
      height={800}
      class="w-full h-[400px] object-cover rounded-lg mb-8"
    />
  ) : (
    lodgify.imageUrl && (
      <img
        src={lodgify.imageUrl.startsWith('//') ? `https:${lodgify.imageUrl}` : lodgify.imageUrl}
        alt={property.name}
        class="w-full h-[400px] object-cover rounded-lg mb-8"
      />
    )
  )
}

